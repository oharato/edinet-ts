edinetのレートリミットやAPIの制限について調べて

----

EDINET API (v2) を利用・ライブラリ化する上で、\*\*レートリミット（アクセス頻度制限）\*\*は最も注意すべき実装ポイントです。

公式仕様書やコミュニティの検証結果に基づく制限の現実は以下の通りです。

### 1\. レートリミットの目安

公式仕様書では明確な「1分間に何回まで」という数値は（一般公開のWebページ上では）明言されていませんが、開発者の間では以下の\*\*「1秒1リクエスト」\*\*が鉄の掟となっています。

  * **推奨頻度:** **1秒に1回程度**
  * **危険ライン:** 短時間に連続リクエスト（並列処理など）を行うと、すぐに **HTTP 429 (Too Many Requests)** が返るか、IPアドレス単位での一時的なブロックが発生します。
  * **並列数:** **1 (直列処理)** を推奨。`Promise.all` で10日分を一気に取りに行くような実装はNGです。

### 2\. ライブラリ開発での実装要件

ユーザーが意識しなくてもBANされないよう、ライブラリ側で以下の機能を実装することが「優しさ」であり、必須要件です。

  * **スロットリング (Throttling):**
    リクエスト間に強制的に `sleep(1000)` などを挟む仕組み。
      * *実装例:* `p-queue` (concurrency: 1) や `bottleneck` などのライブラリを使って、APIコールの行列を作る。
  * **リトライ戦略 (Backoff):**
    `429` エラーが返ってきた場合、即座に再試行せず、**指数関数的バックオフ (Exponential Backoff)** で待機時間を延ばしながらリトライするロジック。
      * *例:* 1秒待機 → 失敗 → 2秒待機 → 失敗 → 4秒待機...

### 3\. その他の制限・注意点 (v2)

  * **APIキー (Subscription Key):**
    v2からは必須です。ヘッダー (`Ocp-Apim-Subscription-Key`) に付与しないと `401 Unauthorized` になります。
  * **リスト取得の制限:**
    書類一覧 (`/documents.json`) は、\*\*「指定した日付の全件」\*\*を返しますが、過去分を大量に遡るようなクローリングは負荷が高いため、特に慎重に行う必要があります。
  * **ZIPファイルのサイズ:**
    有価証券報告書のZIPは数MB〜数十MBになることがあります。これを並列で落とそうとすると、ネットワーク帯域やメモリ（Node.jsのヒープ）を圧迫します。この点でも「直列ダウンロード」が安全です。

### 結論：ライブラリ実装の正解

`edinet-ts` を作るなら、コンストラクタでオプションを受け取れるようにしつつ、**デフォルトは安全側に倒す**のがベストです。

```typescript
// 理想的な初期化オプション
const edinet = new EdinetClient(apiKey, {
  enableRateLimit: true,   // デフォルトON
  requestsPerSecond: 1,    // デフォルト1
  maxRetries: 3            // 429が出たときのリトライ回数
});
```

「ユーザーがループで雑に叩いても、ライブラリ内部で勝手にウェイトを入れて、サーバーを攻撃しないようにしてくれる」というのが、この手のライブラリに最も求められる機能です。